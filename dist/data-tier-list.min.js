import*as DataTier from"./data-tier/data-tier.min.js";const LISTS_MODEL_TIE_NAME="listModel",SEQUENCE_ID_KEY=Symbol("sequence.id"),INDEX_PLACEHOLDER="dtl_index_placeholder",PREPARED_TEMPLATE_KEY=Symbol("prepared.template");let sequencer=1;class DataTierList extends HTMLElement{constructor(){super(),this[SEQUENCE_ID_KEY]=sequencer++,this.attachShadow({mode:"open"}).innerHTML="<slot></slot>",this.shadowRoot.firstElementChild.addEventListener("slotchange",e=>{const t=e.target.assignedNodes().filter(e=>e.nodeType===Node.ELEMENT_NODE);1===t.length?(this.preprocessTemplate(t[0]),this.fullUpdate()):console.error(`list item template MUST have onle 1 root element, got ${t.length}`)})}connectedCallback(){this.style.display="none",this.setAttribute("data-tier-blackbox","1"),DataTier.ties.create(LISTS_MODEL_TIE_NAME+this[SEQUENCE_ID_KEY],[]).observe(e=>this.processModelChanges(e))}disconnectedCallback(){DataTier.ties.remove(LISTS_MODEL_TIE_NAME+this[SEQUENCE_ID_KEY])}get defaultTieTarget(){return"items"}set items(e){if(!Array.isArray(e))return void console.error(`array of items expected, but got '${e}'`);const t=DataTier.ties.get(LISTS_MODEL_TIE_NAME+this[SEQUENCE_ID_KEY]);t.splice(0,t.length,...e)}get items(){return DataTier.ties.get(LISTS_MODEL_TIE_NAME+this[SEQUENCE_ID_KEY])}fullUpdate(){if(!this[PREPARED_TEMPLATE_KEY])return;const e=this.resolveTargetContainer(),t=e.contains(this)?1:0,E=DataTier.ties.get(LISTS_MODEL_TIE_NAME+this[SEQUENCE_ID_KEY]).length;let s,i=e.childElementCount-t;for(;i>E;)(s=e.lastElementChild)!==this&&e.removeChild(s),i--;let r="";const a=new RegExp(INDEX_PLACEHOLDER,"g");for(;i<E;)r+=this[PREPARED_TEMPLATE_KEY].replace(a,i),i++;if(r){const t=document.createElement("template");t.innerHTML=r,e.appendChild(t.content)}}processModelChanges(e){if(e.some(e=>"shuffle"===e.type))this.fullUpdate();else{document.createElement("template");const t=new RegExp(INDEX_PLACEHOLDER,"g");e.forEach(e=>{if("insert"===e.type){this[PREPARED_TEMPLATE_KEY].replace(t,currentListLength)}else e.type})}}resolveTargetContainer(){let e=this.parentElement;const t=this.getAttribute("data-list-target");return t&&(e=this.getRootNode().querySelector(t)),e}preprocessTemplate(e){const t=`${LISTS_MODEL_TIE_NAME}${this[SEQUENCE_ID_KEY]}:${INDEX_PLACEHOLDER}`,E=e.cloneNode(!0),s=[E];E.childElementCount&&Array.prototype.push.apply(s,E.querySelectorAll("*"));let i,r,a=s.length;for(;a;)(r=(i=s[--a]).getAttribute("data-tie"))&&i.setAttribute("data-tie",r.replace(/item:/g,`${t}.`).replace(/item\s*=/g,`${t}=`).replace(/item(?![.a-zA-Z0-9])/g,`${t}`));this[PREPARED_TEMPLATE_KEY]=E.outerHTML}}customElements.get("data-tier-list")||customElements.define("data-tier-list",DataTierList);